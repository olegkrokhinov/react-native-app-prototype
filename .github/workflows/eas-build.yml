name: CI/CD Pipeline (Multi-Variant Support)

# Controls when the workflow will run
on:
  push:
    branches: [master, dev] # Triggers on direct pushes or merged PRs
  pull_request:
    branches: [master] # Runs only for PRs targeting master (e.g., verifying hotfixes)
  workflow_dispatch: # Allows manual builds from the GitHub "Actions" tab
    inputs:
      platform:
        description: "Select platform"
        required: true
        default: "all"
        type: choice
        options: [ios, android, all]

jobs:
  eas-build:
    name: Expo Build Job
    runs-on: ubuntu-latest
    # Environment in which we approve the start of the build process
    environment: master
    steps:
      # Step 1: Clone the repository code to the virtual machine
      - name: üèó Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install Expo CLI and authorize using the EXPO_TOKEN from Secrets
      - name: üèó Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      # Step 3: Install project dependencies (Node.js modules)
      - name: üì¶ Install dependencies
        run: npm install

      # Step 4: PRODUCTION BUILD
      # Executed only on push/merge to master.
      # This step triggers the production variant, icon, and submits to stores.
      - name: üöÄ Production Build & Submit
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        env:
          APP_VARIANT: production # Environment variable used in app.config.js
        run: eas build --platform all --profile production --non-interactive

      # Step 5: PREVIEW BUILD
      # Executed after merge to dev OR during a PR to master (to test a Hotfix).
      # Uses the 'preview' variant settings and icon.
      - name: üì¶ Preview Build
        if: |
          (github.ref == 'refs/heads/dev' && github.event_name == 'push') || 
          (github.base_ref == 'master' && github.event_name == 'pull_request')
        env:
          APP_VARIANT: preview
        run: eas build --platform all --profile preview --non-interactive

      # Step 6: MANUAL BUILD
      # Triggered manually via GitHub UI. Defaults to 'preview' variant.
      - name: üõ† Manual Build
        if: github.event_name == 'workflow_dispatch'
        env:
          APP_VARIANT: preview
        run: eas build --platform ${{ github.event.inputs.platform }} --profile preview --non-interactive
